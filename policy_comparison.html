<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAB Policy Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .config-info p {
            color: #555;
            margin: 5px 0;
        }

        .policy-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .policy-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .policy-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .policy-card h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .policy-card label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
        }

        .policy-card input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .policy-card input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 5px;
        }

        .param-group {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .simulation-control {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .simulation-control label {
            font-weight: 600;
            color: #333;
        }

        .simulation-control input {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 120px;
            text-align: center;
        }

        .run-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .run-btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .run-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .chart-wrapper {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .chart-wrapper h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .results-summary {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .results-summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .results-summary table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-summary th,
        .results-summary td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-summary th {
            background: #667eea;
            color: white;
        }

        .results-summary tr:hover {
            background: #f0f4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Game</a>
        
        <h1>üìä MAB Policy Comparison</h1>
        <p class="subtitle">Compare different exploration strategies and their performance</p>

        <div class="config-section">
            <div class="config-info">
                <h3>Problem Configuration</h3>
                <p><strong>Total Pulls:</strong> <span id="totalPullsDisplay">-</span></p>
                <p><strong>Machine A Probability:</strong> <span id="probADisplay">-</span>%</p>
                <p><strong>Machine B Probability:</strong> <span id="probBDisplay">-</span>%</p>
            </div>

            <h3>Select Policies to Compare</h3>
            <div class="policy-config">
                <div class="policy-card" id="etcCard">
                    <label>
                        <input type="checkbox" id="etcEnabled" checked onchange="togglePolicy('etc')">
                        Explore-Then-Commit (ETC)
                    </label>
                    <div class="param-group">
                        <label for="etcExplore">Initial Explores per Arm:</label>
                        <input type="number" id="etcExplore" value="5" min="1" max="100">
                    </div>
                </div>

                <div class="policy-card" id="ucbCard">
                    <label>
                        <input type="checkbox" id="ucbEnabled" checked onchange="togglePolicy('ucb')">
                        UCB1 (Upper Confidence Bound)
                    </label>
                    <div class="param-group">
                        <p style="color: #666; font-size: 14px;">
                            Uses confidence bounds to balance exploration and exploitation.
                        </p>
                    </div>
                </div>
            </div>

            <div class="simulation-control">
                <label for="numSimulations">Number of Simulations:</label>
                <input type="number" id="numSimulations" value="100" min="1" max="10000">
                <button class="run-btn" id="runBtn" onclick="runSimulations()">Run Simulations</button>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-wrapper">
                <h3>Average Cumulative Reward Over Time</h3>
                <div class="chart-container">
                    <canvas id="rewardChart"></canvas>
                </div>
            </div>

            <div class="chart-wrapper">
                <h3>Average Regret Over Time</h3>
                <div class="chart-container">
                    <canvas id="regretChart"></canvas>
                </div>
            </div>
        </div>

        <div class="results-summary" id="resultsSummary" style="display: none;">
            <h3>Final Results Summary</h3>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Policy</th>
                        <th>Final Avg Reward</th>
                        <th>Final Avg Regret</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const totalPulls = parseInt(urlParams.get('totalPulls')) || 20;
        const randomProb = urlParams.get('randomProb') || 'yes';
        let prob1 = urlParams.get('prob1');
        let prob2 = urlParams.get('prob2');
        const randomAssign = urlParams.get('randomAssign') || 'no';

        let machineProbs = [0, 0];

        // Initialize probabilities
        if (randomProb === 'yes' || prob1 === 'random') {
            // Generate random probabilities
            machineProbs[0] = Math.random();
            machineProbs[1] = Math.random();
        } else {
            prob1 = parseFloat(prob1) / 100;
            prob2 = parseFloat(prob2) / 100;
            
            if (randomAssign === 'yes') {
                machineProbs = Math.random() < 0.5 ? [prob1, prob2] : [prob2, prob1];
            } else {
                machineProbs = [prob1, prob2];
            }
        }

        // Display configuration
        document.getElementById('totalPullsDisplay').textContent = totalPulls;
        document.getElementById('probADisplay').textContent = (machineProbs[0] * 100).toFixed(2);
        document.getElementById('probBDisplay').textContent = (machineProbs[1] * 100).toFixed(2);

        // Chart instances
        let rewardChart = null;
        let regretChart = null;

        function togglePolicy(policyType) {
            const card = document.getElementById(`${policyType}Card`);
            const enabled = document.getElementById(`${policyType}Enabled`).checked;
            
            if (enabled) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        // Initialize selected states
        togglePolicy('etc');
        togglePolicy('ucb');

        // Policy implementations
        function exploreThenCommit(probs, T, m) {
            const K = probs.length;
            const pulls = new Array(K).fill(0);
            const rewards = new Array(K).fill(0);
            let cumulativeReward = 0;
            const rewardHistory = [];
            
            // Exploration phase
            for (let t = 0; t < m * K && t < T; t++) {
                const arm = t % K;
                const reward = Math.random() < probs[arm] ? 1 : 0;
                pulls[arm]++;
                rewards[arm] += reward;
                cumulativeReward += reward;
                rewardHistory.push(cumulativeReward);
            }
            
            // Commit phase
            if (m * K < T) {
                const means = rewards.map((r, i) => pulls[i] > 0 ? r / pulls[i] : 0);
                const bestArm = means.indexOf(Math.max(...means));
                
                for (let t = m * K; t < T; t++) {
                    const reward = Math.random() < probs[bestArm] ? 1 : 0;
                    cumulativeReward += reward;
                    rewardHistory.push(cumulativeReward);
                }
            }
            
            return rewardHistory;
        }

        function ucb1(probs, T) {
            const K = probs.length;
            const pulls = new Array(K).fill(0);
            const rewards = new Array(K).fill(0);
            let cumulativeReward = 0;
            const rewardHistory = [];
            
            // Pull each arm once
            for (let arm = 0; arm < K && arm < T; arm++) {
                const reward = Math.random() < probs[arm] ? 1 : 0;
                pulls[arm]++;
                rewards[arm] += reward;
                cumulativeReward += reward;
                rewardHistory.push(cumulativeReward);
            }
            
            // UCB selection
            for (let t = K; t < T; t++) {
                const ucbValues = pulls.map((n, i) => {
                    if (n === 0) return Infinity;
                    const mean = rewards[i] / n;
                    const confidence = Math.sqrt(2 * Math.log(t) / n);
                    return mean + confidence;
                });
                
                const arm = ucbValues.indexOf(Math.max(...ucbValues));
                const reward = Math.random() < probs[arm] ? 1 : 0;
                pulls[arm]++;
                rewards[arm] += reward;
                cumulativeReward += reward;
                rewardHistory.push(cumulativeReward);
            }
            
            return rewardHistory;
        }

        function calculateRegret(rewardHistory, optimalProb) {
            return rewardHistory.map((cumReward, t) => {
                const optimalReward = (t + 1) * optimalProb;
                return optimalReward - cumReward;
            });
        }

        async function runSimulations() {
            const numSims = parseInt(document.getElementById('numSimulations').value);
            const etcEnabled = document.getElementById('etcEnabled').checked;
            const ucbEnabled = document.getElementById('ucbEnabled').checked;
            
            if (!etcEnabled && !ucbEnabled) {
                alert('Please select at least one policy to compare');
                return;
            }
            
            const etcExplore = parseInt(document.getElementById('etcExplore').value);
            const optimalProb = Math.max(...machineProbs);
            
            // Disable button and show progress
            document.getElementById('runBtn').disabled = true;
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('resultsSummary').style.display = 'none';
            
            const results = {
                etc: { finalRewards: [], finalRegrets: [] },
                ucb: { finalRewards: [], finalRegrets: [] }
            };
            
            // Arrays to track running averages
            const runningAvgRewards = {
                etc: [],
                ucb: []
            };
            
            const runningAvgRegrets = {
                etc: [],
                ucb: []
            };
            
            // Initialize charts with empty data
            initializeCharts(etcEnabled, ucbEnabled);
            
            // Run simulations
            for (let sim = 0; sim < numSims; sim++) {
                if (etcEnabled) {
                    const rewardHistory = exploreThenCommit(machineProbs, totalPulls, etcExplore);
                    const regretHistory = calculateRegret(rewardHistory, optimalProb);
                    const finalReward = rewardHistory[rewardHistory.length - 1];
                    const finalRegret = regretHistory[regretHistory.length - 1];
                    
                    results.etc.finalRewards.push(finalReward);
                    results.etc.finalRegrets.push(finalRegret);
                    
                    // Calculate running average
                    const avgReward = results.etc.finalRewards.reduce((a, b) => a + b, 0) / results.etc.finalRewards.length;
                    const avgRegret = results.etc.finalRegrets.reduce((a, b) => a + b, 0) / results.etc.finalRegrets.length;
                    
                    runningAvgRewards.etc.push(avgReward);
                    runningAvgRegrets.etc.push(avgRegret);
                }
                
                if (ucbEnabled) {
                    const rewardHistory = ucb1(machineProbs, totalPulls);
                    const regretHistory = calculateRegret(rewardHistory, optimalProb);
                    const finalReward = rewardHistory[rewardHistory.length - 1];
                    const finalRegret = regretHistory[regretHistory.length - 1];
                    
                    results.ucb.finalRewards.push(finalReward);
                    results.ucb.finalRegrets.push(finalRegret);
                    
                    // Calculate running average
                    const avgReward = results.ucb.finalRewards.reduce((a, b) => a + b, 0) / results.ucb.finalRewards.length;
                    const avgRegret = results.ucb.finalRegrets.reduce((a, b) => a + b, 0) / results.ucb.finalRegrets.length;
                    
                    runningAvgRewards.ucb.push(avgReward);
                    runningAvgRegrets.ucb.push(avgRegret);
                }
                
                // Update progress
                const progress = ((sim + 1) / numSims * 100).toFixed(0);
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressFill').textContent = progress + '%';
                
                // Update charts periodically (every 5 simulations or on last simulation)
                if ((sim + 1) % 5 === 0 || sim === numSims - 1) {
                    updateCharts(runningAvgRewards, runningAvgRegrets, etcEnabled, ucbEnabled, sim + 1);
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            
            // Show summary
            showSummary(runningAvgRewards, runningAvgRegrets, etcEnabled, ucbEnabled, optimalProb);
            
            // Re-enable button
            document.getElementById('runBtn').disabled = false;
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
            }, 1000);
        }

        function averageArrays(arrays) {
            const length = arrays[0].length;
            const avg = new Array(length).fill(0);
            
            for (let i = 0; i < length; i++) {
                let sum = 0;
                for (let j = 0; j < arrays.length; j++) {
                    sum += arrays[j][i];
                }
                avg[i] = sum / arrays.length;
            }
            
            return avg;
        }

        function initializeCharts(etcEnabled, ucbEnabled) {
            // Destroy existing charts
            if (rewardChart) rewardChart.destroy();
            if (regretChart) regretChart.destroy();
            
            // Reward chart
            const rewardDatasets = [];
            if (etcEnabled) {
                rewardDatasets.push({
                    label: 'Explore-Then-Commit',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    pointRadius: 0
                });
            }
            if (ucbEnabled) {
                rewardDatasets.push({
                    label: 'UCB1',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    pointRadius: 0
                });
            }
            
            const rewardCtx = document.getElementById('rewardChart').getContext('2d');
            rewardChart = new Chart(rewardCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: rewardDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Number of Simulations'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Average Final Cumulative Reward'
                            }
                        }
                    }
                }
            });
            
            // Regret chart
            const regretDatasets = [];
            if (etcEnabled) {
                regretDatasets.push({
                    label: 'Explore-Then-Commit',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    pointRadius: 0
                });
            }
            if (ucbEnabled) {
                regretDatasets.push({
                    label: 'UCB1',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    pointRadius: 0
                });
            }
            
            const regretCtx = document.getElementById('regretChart').getContext('2d');
            regretChart = new Chart(regretCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: regretDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Number of Simulations'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Average Final Regret'
                            }
                        }
                    }
                }
            });
        }

        function updateCharts(runningAvgRewards, runningAvgRegrets, etcEnabled, ucbEnabled, currentSim) {
            const labels = Array.from({ length: currentSim }, (_, i) => i + 1);
            
            // Update reward chart
            rewardChart.data.labels = labels;
            let datasetIndex = 0;
            if (etcEnabled) {
                rewardChart.data.datasets[datasetIndex].data = runningAvgRewards.etc;
                datasetIndex++;
            }
            if (ucbEnabled) {
                rewardChart.data.datasets[datasetIndex].data = runningAvgRewards.ucb;
            }
            rewardChart.update('none');
            
            // Update regret chart
            regretChart.data.labels = labels;
            datasetIndex = 0;
            if (etcEnabled) {
                regretChart.data.datasets[datasetIndex].data = runningAvgRegrets.etc;
                datasetIndex++;
            }
            if (ucbEnabled) {
                regretChart.data.datasets[datasetIndex].data = runningAvgRegrets.ucb;
            }
            regretChart.update('none');
        }

        function showSummary(runningAvgRewards, runningAvgRegrets, etcEnabled, ucbEnabled, optimalProb) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            if (etcEnabled) {
                const finalReward = runningAvgRewards.etc[runningAvgRewards.etc.length - 1];
                const finalRegret = runningAvgRegrets.etc[runningAvgRegrets.etc.length - 1];
                const successRate = (finalReward / totalPulls * 100).toFixed(2);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>Explore-Then-Commit</td>
                    <td>${finalReward.toFixed(2)}</td>
                    <td>${finalRegret.toFixed(2)}</td>
                    <td>${successRate}%</td>
                `;
            }
            
            if (ucbEnabled) {
                const finalReward = runningAvgRewards.ucb[runningAvgRewards.ucb.length - 1];
                const finalRegret = runningAvgRegrets.ucb[runningAvgRegrets.ucb.length - 1];
                const successRate = (finalReward / totalPulls * 100).toFixed(2);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>UCB1</td>
                    <td>${finalReward.toFixed(2)}</td>
                    <td>${finalRegret.toFixed(2)}</td>
                    <td>${successRate}%</td>
                `;
            }
            
            document.getElementById('resultsSummary').style.display = 'block';
        }
    </script>
</body>
</html>
